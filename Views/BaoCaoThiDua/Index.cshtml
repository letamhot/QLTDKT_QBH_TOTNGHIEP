@model List<QLTDKT.Models.qltdkt_dm_thidua>
@{
    ViewBag.Title = "Index";
}
<br />
<div class="container-fluid">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="#">Báo cáo thống kê</a></li>
        <li class="breadcrumb-item active">Báo cáo thi đua</li>
    </ol>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body" id="frmSearch">
                    @*<div class="dropdown float-right">
                            <a href="#" class="dropdown-toggle card-drop" data-toggle="dropdown" aria-expanded="false">
                                <i class="mdi mdi-dots-vertical"></i>
                            </a>
                        </div>*@
                    <h4 class="header-title mb-6" style="font-size: 20px;">Báo cáo thi đua</h4>
                    <div class="row form-horizontal">
                        <div class="col-xl-6">
                            <div class="form-group row">
                                <label class="col-md-3 col-form-label" for="btnGroupTieuChi">Chọn tiêu chí:</label>
                                <div class="col-md-9">
                                    <div class="btn-group">
                                        <button id="btnNgay" class="btn btn-default waves-effect waves-light">Ngày chi tiết</button>
                                        <button id="btnThang" class="btn btn-default waves-effect waves-light">Tháng</button>
                                        <button id="btnQuy" class="btn btn-default waves-effect waves-light">Quý</button>
                                        <button id="btnNam" class="btn btn-default waves-effect waves-light">Năm</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row form-horizontal" id="regionNgay">
                        <div class="col-xl-6">
                            <div class="form-group row">
                                <label class="col-md-3 col-form-label"></label>
                                <div class="col-md-9">
                                    <div class="form-group row">
                                        <label class="col-md-3 col-form-label" for="dtNgayPhatDongSearch_TuNgay">Từ ngày:</label>
                                        <div class="col-md-9">
                                            @*<input type="text" id="dtNgayPhatDongSearch_TuNgay" name="dtNgayPhatDongSearch_TuNgay" class="form-control" placeholder="">*@
                                            <div id="dateNgayPhatDong_TuNgay" class="input-group date" data-date-format="dd/mm/yyyy"> <input id="dtNgay_TuNgay" name="dtNgay_TuNgay" placeholder="dd/mm/yyyy..." class="form-control" type="text"> <span class="input-group-addon"><i class="fa fa-lg fa-calendar"></i></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-6">
                            <div class="form-group row">
                                <label class="col-md-3 col-form-label"></label>
                                <div class="col-md-9">
                                    <div class="form-group row">
                                        <label class="col-md-3 col-form-label" for="dtNgayPhatDongSearch_DenNgay">Đến ngày:</label>
                                        <div class="col-md-9">
                                            @*<input type="text" id="dtNgayPhatDongSearch_DenNgay" name="dtNgayPhatDongSearch_DenNgay" class="form-control" placeholder="">*@
                                            <div id="dateNgayPhatDong_DenNgay" class="input-group date" data-date-format="dd/mm/yyyy"> <input id="dtNgay_DenNgay" name="dtNgay_DenNgay" placeholder="dd/mm/yyyy..." class="form-control" type="text"> <span class="input-group-addon"><i class="fa fa-lg fa-calendar"></i></span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row form-horizontal">
                        <div class="col-xl-6" id="regionThang" style="display: none;">
                            <div class="form-group row">
                                <label class="col-md-3 col-form-label"></label>
                                <div class="col-md-9">
                                    <div class="form-group row">
                                        <label class="col-md-3 col-form-label" for="cbxThang">Tháng:</label>
                                        <div class="col-md-9">
                                            <select id="cbxThang" name="cbxThang" class="form-control">
                                                <option value="01">Tháng 1</option>
                                                <option value="02">Tháng 2</option>
                                                <option value="03">Tháng 3</option>
                                                <option value="04">Tháng 4</option>
                                                <option value="05">Tháng 5</option>
                                                <option value="06">Tháng 6</option>
                                                <option value="07">Tháng 7</option>
                                                <option value="08">Tháng 8</option>
                                                <option value="09">Tháng 9</option>
                                                <option value="10">Tháng 10</option>
                                                <option value="11">Tháng 11</option>
                                                <option value="12">Tháng 12</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-6" id="regionNam" style="display: none;">
                            <div class="form-group row">
                                <label class="col-md-3 col-form-label"></label>
                                <div class="col-md-9">
                                    <div class="form-group row">
                                        <label class="col-md-3 col-form-label" for="cbxThang">Năm:</label>
                                        <div class="col-md-9">

                                            <select id="cbxNam" name="cbxNam" class="form-control">
                                                @for (int i = 0; i < 10; i++)
                                                {
                                                    <option value="@(DateTime.Now.Year - i)">@(DateTime.Now.Year - i)</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row form-horizontal" id="regionQuy" style="display: none;">
                        <div class="col-xl-6">
                            <div class="form-group row">
                                <label class="col-md-3 col-form-label"></label>
                                <div class="col-md-9">
                                    <div class="form-group row">
                                        <label class="col-md-3 col-form-label" for="cbxQuy">Quý:</label>
                                        <div class="col-md-9">
                                            <select id="cbxQuy" name="cbxQuy" class="form-control">
                                                <option value="1">Quý 1</option>
                                                <option value="2">Quý 2</option>
                                                <option value="3">Quý 3</option>
                                                <option value="4">Quý 4</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row form-horizontal">
                        <div class="col-xl-6">
                            <div class="form-group row">
                                <label class="col-md-3 col-form-label"></label>
                                <div class="col-md-9">
                                    <div class="form-group row">
                                        <label class="col-md-3 col-form-label" for="cbxKieu">Kiểu:</label>
                                        <div class="col-md-9">
                                            <select id="cbxKieu" name="cbxKieu" class="form-control" onchange="loadDmThiDua()">
                                                <option value="">--Chọn kiểu thi đua--</option>
                                                <option value="0">Năm</option>
                                                <option value="1">Giai đoạn</option>
                                                <option value="2">Chuyên đề</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-6">
                            <div class="form-group row">
                                <div class="col-md-9">
                                    <div class="form-group row">
                                        <label class="col-md-3 col-form-label" for="cbxThiDua">Nội dung:</label>
                                        <div class="col-md-9">
                                            <select id="cbxThiDua" name="cbxThiDua" class="form-control">
                                            </select>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row form-horizontal">
                        <div class="col-xl-6">
                            <div class="form-group row">
                                <label class="col-md-3 col-form-label"></label>
                                <div class="col-md-9">
                                    <button class="btn btn-info" id="btnDisplay"><i class="fa fa-desktop"></i> Hiển thị</button>
                                    <button class="btn btn-danger" id="btnXuatExcel"><i class="fa fa-file-excel"></i> Xuất Excel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br />
                    <table id="table_thidua" class="table table-striped table-bordered dt-responsive nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%; ">
                    </table>
                </div>

            </div>
        </div>
    </div>
    <div class="row">
        @*<a href="@Url.Action("ExportExcel", "BaoCaoThiDua", new { thiDua = 2, type = 1 })">Xuất</a>*@
    </div>
</div>
<script>
    var flag_bt = 0;
    $(document).ready(function () {
        activeMenu("liBaoCao", "liBaoCaoThiDua");
        $.noConflict();
        $("#dateNgayPhatDong_TuNgay").datepicker({
            autoclose: true,
            todayHighlight: true,
            orientation: 'bottom'
        }).datepicker('update');
        $("#dateNgayPhatDong_DenNgay").datepicker({
            autoclose: true,
            todayHighlight: true,
            orientation: 'bottom'
        }).datepicker('update');
    });
    $("#btnNgay").click(function () {
        $("#regionNgay").css("display", "");
        $("#regionThang").css("display", "none");
        $("#regionQuy").css("display", "none");
        $("#regionNam").css("display", "none");
        flag_bt = 0;
    })
    $("#btnThang").click(function () {
        $("#regionNgay").css("display", "none");
        $("#regionThang").css("display", "");
        $("#regionQuy").css("display", "none");
        $("#regionNam").css("display", "");
        flag_bt = 1;
    })
    $("#btnQuy").click(function () {
        $("#regionNgay").css("display", "none");
        $("#regionThang").css("display", "none");
        $("#regionQuy").css("display", "");
        $("#regionNam").css("display", "");
        flag_bt = 2;
    })
    $("#btnNam").click(function () {
        $("#regionNgay").css("display", "none");
        $("#regionThang").css("display", "none");
        $("#regionQuy").css("display", "none");
        $("#regionNam").css("display", "");
        flag_bt = 3;
    })



    function validator() {
        $('#frmSearch').bootstrapValidator({
            //container: 'tooltip',
            message: 'Giá trị không hợp lệ',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
                dtNgay_TuNgay: {
                    validators: {
                        notEmpty: {
                            message: 'Nhập thời gian từ ngày!'
                        }
                    }
                },
                dtNgay_DenNgay: {
                    validators: {
                        notEmpty: {
                            message: 'Nhập thời gian đến ngày!'
                        }
                    }
                },
                cbxKieu: {
                    validators: {
                        notEmpty: {
                            message: 'Chọn kiểu!'
                        }
                    }
                },
                cbxThiDua: {
                    validators: {
                        notEmpty: {
                            message: 'Chọn thi đua!'
                        }
                    }
                }
            }

        });
        var validatorObj = $('#frmSearch').data('bootstrapValidator');
        validatorObj.validate();
        if (validatorObj.isValid()) {
            return true;
        }
        return false;
    }
    $("#btnDisplay").click(function () {
        var isValid = validator();
        if (isValid) {
            hienThiBaoCao();

        }
    })
    function loadDmThiDua(kieuThiDua = "", idDmThiDua = 0) {
        if (kieuThiDua == "") {
            kieuThiDua = $("#cbxKieu").val();
        }
        $.get("/BaoCaoThiDua/GetDmThiDuaByKieu", { kieuThiDua: kieuThiDua }, function (data) {
            var html = '';
            html = '<option value = "">--Chọn thi đua--</option>';
            $.each(data.data, function (key, item) {
                if (item.id == idDmThiDua) {
                    html += '<option value = ' + item.id + ' selected>' + item.tenThiDua + '</option>';
                }
                else {
                    html += '<option value = ' + item.id + '>' + item.tenThiDua + '</option>';
                }

            });
            $('#cbxThiDua').html(html);
        })
    }
    function hienThiBaoCao() {
        //console.log(getMocThoiGian(flag_bt));
            var kieu = $("#cbxKieu").val();
            var html = "";
            if (kieu == 0) {
                html += "<thead><th>STT</th><th>Quyết định</th><th>Ngày ban hành</th><th>Tên cá nhân</th><th>Tập thể</th><th>Chức vụ</th><th>Nội dung thi đua</th></thead>";
            }if (kieu == 1) {
                html += "<thead><th>STT</th><th>Quyết định</th><th>Ngày ban hành</th><th>Tên cá nhân</th><th>Tập thể</th><th>Chức vụ</th><th>Nội dung thi đua</th></thead>";
            }
            if (kieu == 2) {
                html += "<thead><th>STT</th><th>Quyết định</th><th>Ngày ban hành</th><th>Tên cá nhân</th><th>Tập thể</th><th>Chức vụ</th><th>Nội dung thi đua</th></thead>";
            }
            $("#table_thidua").html(html);
            var time = getMocThoiGian(flag_bt);
            console.log(time);

            $.ajax({
                url: "/BaoCaoThiDua/GetBaoCao",
                type: "GET",
                dataType: "json",
                data: {
                    from: time[0],
                    to: time[1],
                    thiDua: $("#cbxThiDua").val(),
                    type: $("#cbxKieu").val(),

                },
                beforeSend: function () {
                    $("#overlay").fadeIn(300);
                },
                success: function (data) {
                    // Do stuff...
                    console.log("data", data);
                    var stt = 0;
                    if (data.data.length > 0) {
                        html += "<tbody>";
                        if (kieu == 0) {
                            $.each(data.data, function (key, item) {
                                stt++;
                                html += '<tr><td>' + stt + '</td><td><b>' + item.soQuyetDinh + '</b></td><td>' + removeToShortDay(item.ngayPhatDong) + '</td ><td>' + item.tenDonVi_CaNhan + '</td><td>' + item.donVi + '</td><td>' + item.chucVu + '</td><td>' + item.noiDungThiDua + '</td></tr>';

                            });
                        }if (kieu == 1) {
                            $.each(data.data, function (key, item) {
                                stt++;
                                html += '<tr><td>' + stt + '</td><td><b>' + item.soQuyetDinh + '</b></td><td>' + removeToShortDay(item.ngayPhatDong) + '</td ><td>' + item.tenDonVi_CaNhan + '</td><td>' + item.donVi + '</td><td>' + item.chucVu + '</td><td>' + item.noiDungThiDua + '</td></tr>';

                            });
                        }
                        if (kieu == 2) {
                            $.each(data.data, function (key, item) {
                                console.log("item", item.donVi);
                                stt++;
                                html += '<tr><td>' + stt + '</td><td><b>' + item.soQuyetDinh + '</b></td><td>' + removeToShortDay(item.ngayPhatDong) + '</td ><td>' + item.tenDonVi_CaNhan + '</td><td>' + item.donVi + '</td><td>' + item.chucVu + '</td><td>' + item.noiDungThiDua + '</td></tr>';

                            });
                        }
                        html += "</tbody>";
                        console.log(html);
                        $("#table_thidua").html(html);
                        @*$("#table_thidua").DataTable({
                            paging: false,
                            searching: false,
                            retrieve: true,
                            destroy: false,

                        });*@

                    }
                    else {
                        if (kieu == 0) {
                            html += "<tr><td colspan='7' style='text-align: center;'>Không có nội dung hiển thị</td></tr>";
                        }if (kieu == 1) {
                            html += "<tr><td colspan='7' style='text-align: center;'>Không có nội dung hiển thị</td></tr>";
                        }
                        if (kieu == 2) {
                            html += "<tr><td colspan='7' style='text-align: center;'>Không có nội dung hiển thị</td></tr>";
                        }
                        $("#table_thidua").html(html);
                    }
                },
                complete: function () {
                    $("#overlay").fadeOut(300);
                }

            });


        //$("#table_thidua").html(html);
    }

    function getMocThoiGian(flag) {
        var result = [];
        var tuNgay = "", denNgay = "";
        if (flag == 0) {
            result.push($("#dtNgay_TuNgay").val());
            result.push($("#dtNgay_DenNgay").val());
        }
        if (flag == 1) {
            tuNgay = "01" + "/" + $("#cbxThang").val() + "/" + $("#cbxNam").val();
            var lastDayOfMonth = getLastDay($("#cbxNam").val(), $("#cbxThang").val());
            console.log(lastDayOfMonth);
            denNgay = lastDayOfMonth + "/" + $("#cbxThang").val() + "/" + $("#cbxNam").val();
            result.push(tuNgay);
            result.push(denNgay);
        }
        if (flag == 2) {
            var quy = $("#cbxQuy").val();
            if (quy == 1) {
                tuNgay = "01/01/" + $("#cbxNam").val();
                denNgay = "31/03/" + $("#cbxNam").val();
            }
            if (quy == 2) {
                tuNgay = "01/04/" + $("#cbxNam").val();
                denNgay = "30/06/" + $("#cbxNam").val();
            }
            if (quy == 3) {
                tuNgay = "01/07/" + $("#cbxNam").val();
                denNgay = "30/09/" + $("#cbxNam").val();
            }
            if (quy == 4) {
                tuNgay = "01/10/" + $("#cbxNam").val();
                denNgay = "31/12/" + $("#cbxNam").val();
            }
            result.push(tuNgay);
            result.push(denNgay);
        }
        if (flag == 3) {
            tuNgay = "01/01/" + $("#cbxNam").val();
            denNgay = "31/12/" + $("#cbxNam").val();
            result.push(tuNgay);
            result.push(denNgay);
        }
        return result;
    }

    $("#btnXuatExcel").click(function () {

        var time = getMocThoiGian(flag_bt);
        var url = '@Url.Action("ExportExcel", "BaoCaoThiDua", new RouteValueDictionary(new { from = "t_from", to = "t_to", thiDua = "t_thiDua", type = "t_type"}))'.replace("t_from", encodeURIComponent(time[0]));
        url = url.replace("t_to", encodeURIComponent(time[1]));
        url = url.replace("t_thiDua", encodeURIComponent($("#cbxThiDua").val()));
        url = url.replace("t_type", encodeURIComponent($("#cbxKieu").val()));
        url = url.replace(/&amp;/g, "&");
        window.location.href = url;
    })

    function getLastDay(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

  function removeToShortDay(day) {
        var spl = day.split(" ");
        return spl[0];
    }
</script>

